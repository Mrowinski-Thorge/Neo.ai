<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Private KI direkt im Browser - 100% offline-fÃ¤hig" />
  <meta name="theme-color" content="#0a0a1a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="NeoAI" />
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTmVvQUkgQ2hhdCIsInNob3J0X25hbWUiOiJOZW9BSSIsInN0YXJ0X3VybCI6Ii4vIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBhMGExYSIsInRoZW1lX2NvbG9yIjoiIzBhMGExYSIsImRlc2NyaXB0aW9uIjoiUHJpdmF0ZSBLSSBkaXJla3QgaW0gQnJvd3NlciIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSTFNVE1pSUdobGFXZG9kRDBpTlRFeklqNDhjbVZqZENCM2FXUjBhRDBpTlRFeklpQm9aV2xuYUhROUlqVXhNeUlnY21nOUlqSTFOaUlnWm1sc2JEMGlJell6TmpabU1TSXZQanh3WVhSb0lHUTlJazB5TlRZZ01UVTJhREV3TUhZdE1UQXdhREV3TUhZeE1EQm9NVEF3ZGkweE1EQjZJaUJtYVd4c1BTSWpabVptSWk4K1BDOXpkbWMrIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjUxMng1MTIiLCJwdXJwb3NlIjoiYW55IG1hc2thYmxlIn1dfQ==" />
  <title>NeoAI Chat â€¢ Lokale KI</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            surface: { 50: '#1a1a2e', 100: '#16162a', 200: '#0f0f23', 300: '#0a0a1a' },
            accent: { 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5' },
            chat: { user: '#1e1e3a', ai: '#12122a' }
          },
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
        }
      }
    };
  </script>

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    /* Dark theme (default) */
    body.dark {
      margin: 0;
      padding: 0;
      background: #0a0a1a;
      color: #ffffff;
      font-family: 'Inter', system-ui, sans-serif;
      overflow: hidden;
    }

    /* Light theme */
    body.light {
      margin: 0;
      padding: 0;
      background: #f8f9fa;
      color: #1a1a1a;
      font-family: 'Inter', system-ui, sans-serif;
      overflow: hidden;
    }

    /* Light theme overrides - using Tailwind's dark mode class approach */
    body.light .bg-surface-300 { background-color: #ffffff !important; }
    body.light .bg-surface-200 { background-color: #f1f3f5 !important; }
    body.light .bg-surface-100 { background-color: #e9ecef !important; }
    body.light .bg-surface-50 { background-color: #dee2e6 !important; }
    body.light .text-white { color: #1a1a1a !important; }
    body.light .text-gray-400 { color: #6c757d !important; }
    body.light .text-gray-300 { color: #495057 !important; }
    body.light .text-gray-200 { color: #343a40 !important; }
    body.light .text-gray-500 { color: #868e96 !important; }
    body.light .border-white\/10 { border-color: rgba(0,0,0,0.1) !important; }
    body.light .border-white\/5 { border-color: rgba(0,0,0,0.05) !important; }
    body.light .bg-white\/5 { background-color: rgba(0,0,0,0.03) !important; }
    body.light .bg-white\/8 { background-color: rgba(0,0,0,0.05) !important; }
    body.light .ai-bubble { background-color: #f1f3f5 !important; border-color: rgba(0,0,0,0.1) !important; color: #1a1a1a !important; }

    ::-webkit-scrollbar { width: 8px; }
    body.dark ::-webkit-scrollbar-track { background: transparent; }
    body.dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
    body.dark ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    body.light ::-webkit-scrollbar-track { background: transparent; }
    body.light ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }
    body.light ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }

    /* Animation keyframes */
    .typing-dot { animation: blink 1.4s infinite both; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%, 80%, 100% { opacity: 0.2; } 40% { opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }
    .msg-animate { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .slide-in { animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(99,102,241,0.15); } 50% { box-shadow: 0 0 40px rgba(99,102,241,0.3); } }
    .glow-pulse { animation: pulse-glow 2s ease-in-out infinite; }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .shimmer-bar { background: linear-gradient(90deg, #1e1e3a 25%, #2a2a4a 50%, #1e1e3a 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }

    /* Markdown/Prose styling */
    .prose-chat { line-height: 1.6; }
    .prose-chat p { margin: 0.5em 0; }
    .prose-chat p:first-child { margin-top: 0; }
    .prose-chat p:last-child { margin-bottom: 0; }
    .prose-chat ul, .prose-chat ol { margin: 0.6em 0; padding-left: 1.5em; }
    .prose-chat li { margin: 0.3em 0; }
    .prose-chat code {
      background: rgba(255,255,255,0.08);
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-size: 0.88em;
      font-family: 'Consolas', 'Monaco', monospace;
    }
    .prose-chat pre {
      background: rgba(0,0,0,0.4);
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
      margin: 0.8em 0;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .prose-chat pre code { background: transparent; padding: 0; }
    .prose-chat a { color: #818cf8; text-decoration: underline; }
    .prose-chat a:hover { color: #a5b4fc; }
    .prose-chat strong { font-weight: 600; color: #fff; }
    .prose-chat h1, .prose-chat h2, .prose-chat h3 { margin: 0.8em 0 0.4em; font-weight: 600; color: #fff; }

    /* Bubble message styling */
    .message-bubble {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      word-wrap: break-word;
    }
    .user-bubble {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: #fff;
      margin-left: auto;
      border-bottom-right-radius: 6px;
    }
    .ai-bubble {
      background: rgba(255,255,255,0.04);
      color: #e5e5e5;
      border: 1px solid rgba(255,255,255,0.06);
      border-bottom-left-radius: 6px;
    }

    /* Toggle styling */
    .toggle-track { transition: background-color 0.2s; }
    .toggle-thumb { transition: transform 0.2s; }
  </style>
</head>
<body class="dark">

<div id="root"></div>

<script type="text/babel" data-type="module">
/* ======================================================================
   NeoAI Chat â€“ Single-File React App
   Lokale KI via WebGPU Â· Wikipedia RAG Â· Offline-First
   ====================================================================== */

const { useState, useEffect, useRef, useCallback, useMemo } = React;

// â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY   = 'neoai-chat-history';
const SESSIONS_KEY  = 'neoai-chat-sessions';
const SETTINGS_KEY  = 'neoai-settings';
const THEME_KEY     = 'neoai-theme';
const WIKI_API      = 'https://de.wikipedia.org/w/api.php';
const DB_NAME       = 'neoai-chat-sessions';
const DB_VERSION    = 1;
const DB_STORE      = 'sessions';
const MODEL_CACHE_NAME = 'neoai-model-cache';

// Available models for selection
const AVAILABLE_MODELS = [
  {
    id: 'HuggingFaceTB/SmolLM2-360M-Instruct',
    name: 'SmolLM2-360M',
    description: 'Kompaktes SmolLM2 Instruct (ONNX q4f16)',
    size: '~273 MB',
    icon: 'ðŸŸ¢'
  }
];

const DEFAULT_MODEL = 'HuggingFaceTB/SmolLM2-360M-Instruct';
const DEFAULT_MODEL_FILE = 'onnx/model_q4f16.onnx';
const modelCacheRequest = (modelId) => new Request(`https://neoai.local/cache/${encodeURIComponent(modelId)}`);

// â”€â”€â”€ Worker Source (Blob) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const workerCode = `
import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.4.1';

env.allowLocalModels = false;

let generator = null;
let currentModelId = null;
let hfToken = null;
const FALLBACK_MODEL_ID = '${DEFAULT_MODEL}';
const FALLBACK_MODEL_FILE = '${DEFAULT_MODEL_FILE}';

async function loadModel(modelId) {
  const targetModel = modelId || FALLBACK_MODEL_ID;
  if (generator && currentModelId === targetModel) return;
  self.postMessage({ type: 'status', message: 'Lade Modell: ' + targetModel + '...', stage: 'loading' });

  try {
    // Set HF token if available
    if (hfToken) {
      env.remoteModels = { accessToken: hfToken };
    }

    try {
      generator = await pipeline('text-generation', targetModel, {
        device: 'webgpu',
        dtype: 'q4',
        model_file: FALLBACK_MODEL_FILE,
        progress_callback: (p) => {
          if (p.status === 'progress' && p.progress != null) {
            self.postMessage({ type: 'progress', progress: Math.round(p.progress), file: p.file || '' });
          } else if (p.status === 'done') {
            self.postMessage({ type: 'status', message: 'Modell-Datei geladen', stage: 'loaded_file' });
          }
        }
      });
    } catch (quantErr) {
      self.postMessage({ type: 'status', message: 'Falle zurÃ¼ck auf Standard-Dateiâ€¦', stage: 'retry' });
      generator = await pipeline('text-generation', targetModel, {
        device: 'webgpu',
        dtype: 'q4',
        progress_callback: (p) => {
          if (p.status === 'progress' && p.progress != null) {
            self.postMessage({ type: 'progress', progress: Math.round(p.progress), file: p.file || '' });
          } else if (p.status === 'done') {
            self.postMessage({ type: 'status', message: 'Modell-Datei geladen', stage: 'loaded_file' });
          }
        }
      });
    }
    currentModelId = targetModel;
    self.postMessage({ type: 'status', message: 'Modell bereit!', stage: 'ready' });
  } catch (err) {
    // Clear any partially downloaded model from cache
    generator = null;
    currentModelId = null;
    self.postMessage({ type: 'error', message: 'Fehler beim Laden: ' + err.message, shouldClearCache: true });
    throw err;
  }
}

async function generate(messages, id) {
  if (!generator) {
    self.postMessage({ type: 'error', message: 'Kein Modell geladen.', id });
    return;
  }

  try {
    const result = await generator(messages, {
      max_new_tokens: 768,
      temperature: 0.6,
      top_p: 0.9,
      do_sample: true,
    });

    const output = result[0]?.generated_text;
    let answer = '';
    if (Array.isArray(output)) {
      const last = output[output.length - 1];
      answer = last?.content || '';
    } else if (typeof output === 'string') {
      const fullPrompt = messages.map(m => m.content).join('');
      answer = output.slice(fullPrompt.length).trim();
    }

    self.postMessage({ type: 'result', text: answer, id });
  } catch (err) {
    self.postMessage({ type: 'error', message: 'Generierung fehlgeschlagen: ' + err.message, id });
  }
}

self.onmessage = async (e) => {
  const { type, modelId, messages, id, token } = e.data;
  if (type === 'setToken') {
    hfToken = token;
    self.postMessage({ type: 'tokenSet', success: true });
  } else if (type === 'load') {
    try { await loadModel(modelId); } catch(_) {}
  } else if (type === 'generate') {
    if (!generator) await loadModel(modelId || FALLBACK_MODEL_ID);
    await generate(messages, id);
  }
};
`;

function createWorker() {
  const blob = new Blob([workerCode], { type: 'application/javascript' });
  const url = URL.createObjectURL(blob);
  return new Worker(url, { type: 'module' });
}

// â”€â”€â”€ localStorage Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadHistory() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch { return []; }
}
function saveHistory(msgs) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(msgs)); } catch {}
}
function loadSettings() {
  try {
    const raw = localStorage.getItem(SETTINGS_KEY);
    if (!raw) return { selectedModel: DEFAULT_MODEL, theme: 'dark' };
    const parsed = JSON.parse(raw);
    if (parsed.selectedModel !== DEFAULT_MODEL) {
      parsed.selectedModel = DEFAULT_MODEL;
    }
    return { selectedModel: DEFAULT_MODEL, theme: 'dark', ...parsed };
  } catch { return { selectedModel: DEFAULT_MODEL, theme: 'dark' }; }
}
function saveSettings(s) {
  try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); } catch {}
}

// â”€â”€â”€ Session Management (IndexedDB) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createDefaultSession(name = 'Chat 1') {
  const ts = Date.now();
  return { id: ts, name, messages: [], createdAt: ts, updatedAt: ts };
}

function openSessionDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = () => {
      const db = request.result;
      if (!db.objectStoreNames.contains(DB_STORE)) {
        db.createObjectStore(DB_STORE, { keyPath: 'id' });
      }
    };
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function loadSessionsFromDB() {
  try {
    const db = await openSessionDB();
    return await new Promise((resolve, reject) => {
      const tx = db.transaction(DB_STORE, 'readonly');
      const store = tx.objectStore(DB_STORE);
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  } catch {
    return [];
  }
}

async function saveSessionsToDB(sessions) {
  try {
    const db = await openSessionDB();
    await new Promise((resolve, reject) => {
      const tx = db.transaction(DB_STORE, 'readwrite');
      const store = tx.objectStore(DB_STORE);
      store.clear();
      sessions.forEach((s) => store.put(s));
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  } catch (err) {
    console.warn('Could not persist sessions to IndexedDB', err);
  }
}

// â”€â”€â”€ Cache Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function clearModelCache() {
  try {
    // Clear IndexedDB caches used by transformers.js
    const dbs = await indexedDB.databases();
    for (const db of dbs) {
      if (db.name && (db.name.includes('transformers') || db.name.includes('onnx') || db.name.includes('cache'))) {
        indexedDB.deleteDatabase(db.name);
      }
    }
    console.log('Model cache cleared');
  } catch (err) {
    console.warn('Could not clear cache:', err);
  }
}

async function isModelCached(modelId) {
  if (!('caches' in window)) return false;
  try {
    const cache = await caches.open(MODEL_CACHE_NAME);
    const match = await cache.match(modelCacheRequest(modelId));
    return !!match;
  } catch {
    return false;
  }
}

async function markModelCached(modelId) {
  if (!('caches' in window)) return;
  try {
    const cache = await caches.open(MODEL_CACHE_NAME);
    await cache.put(modelCacheRequest(modelId), new Response('cached', {
      headers: { 'Content-Type': 'text/plain' }
    }));
  } catch (err) {
    console.warn('Could not mark model cache', err);
  }
}

// â”€â”€â”€ RAM Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getApproximateMemoryUsage() {
  if (performance.memory) {
    return {
      used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
      total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
      limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
    };
  }
  return null;
}

function isLowMemory() {
  const mem = getApproximateMemoryUsage();
  if (!mem) return false;
  // Consider low memory if using more than 80% of available heap
  return (mem.used / mem.limit) > 0.8;
}

// Unload model and force garbage collection
async function unloadModel(worker) {
  if (worker) {
    worker.terminate();
  }
  // Force garbage collection if available (Chrome with --enable-precise-memory-info)
  if (window.gc) {
    window.gc();
  }
  console.log('Model unloaded for memory conservation');
}

// â”€â”€â”€ Wikipedia API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Extract keywords from user query for better Wikipedia search
function extractKeywords(text) {
  // Remove common German stop words and extract meaningful terms
  const stopWords = ['der', 'die', 'das', 'ein', 'eine', 'und', 'oder', 'aber', 'in', 'zu', 'von', 'mit', 'fÃ¼r', 'auf', 'ist', 'sind', 'war', 'wird', 'werden', 'hat', 'haben', 'kann', 'kannst', 'soll', 'sollte', 'was', 'wie', 'wer', 'wo', 'wann', 'warum', 'welche', 'welcher', 'welches', 'mir', 'mich', 'dir', 'dich', 'sich', 'uns', 'euch', 'ihnen'];

  // Split text into words and filter
  const words = text.toLowerCase()
    .replace(/[^\wÃ¤Ã¶Ã¼ÃŸ\s]/g, ' ')
    .split(/\s+/)
    .filter(w => w.length > 3 && !stopWords.includes(w));

  // Return first 3 keywords or original text if no good keywords found
  return words.length > 0 ? words.slice(0, 3).join(' ') : text;
}

async function searchWikipedia(query) {
  // Extract keywords for better search results
  const searchTerms = extractKeywords(query);

  const searchUrl = `${WIKI_API}?action=query&list=search&srsearch=${encodeURIComponent(searchTerms)}&srlimit=1&format=json&origin=*`;
  const searchRes = await fetch(searchUrl);
  const searchData = await searchRes.json();
  const results = searchData?.query?.search;
  if (!results || results.length === 0) return null;

  const title = results[0].title;
  const extUrl = `${WIKI_API}?action=query&titles=${encodeURIComponent(title)}&prop=extracts&exintro=true&explaintext=true&format=json&origin=*`;
  const extRes = await fetch(extUrl);
  const extData = await extRes.json();
  const pages = extData?.query?.pages;
  if (!pages) return null;

  const page = Object.values(pages)[0];
  const extract = page?.extract || '';
  // Kompakter Kontext fÃ¼r SmolLM2
  return { title: page.title, text: extract.slice(0, 2500) };
}

// â”€â”€â”€ Markdown Renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMarkdown(text) {
  if (!text) return '';
  try {
    return marked.parse(text, { breaks: true, gfm: true });
  } catch {
    return text.replace(/\n/g, '<br/>');
  }
}

// â”€â”€â”€ Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Toggle Switch
function Toggle({ enabled, onChange, label }) {
  return (
    <button
      onClick={() => onChange(!enabled)}
      className="flex items-center gap-2 text-sm select-none"
      aria-label={label}
    >
      <div className={`toggle-track relative w-10 h-5 rounded-full ${enabled ? 'bg-accent-500' : 'bg-gray-600'}`}>
        <div className={`toggle-thumb absolute top-0.5 left-0.5 w-4 h-4 rounded-full bg-white shadow ${enabled ? 'transform translate-x-5' : ''}`} />
      </div>
      <span className="text-gray-300 text-xs sm:text-sm whitespace-nowrap">{label}</span>
    </button>
  );
}

// Sidebar navigation
function Sidebar({ open, onClose, sessions, currentSessionId, onSessionChange, onNewSession, wikiEnabled, onToggleWiki, modelStatus, modelCached, onLoadModel }) {
  return (
    <>
      <div
        className={`fixed inset-0 bg-black/40 lg:hidden transition-opacity duration-200 ${open ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}
        onClick={onClose}
      />
      <aside className={`fixed lg:static inset-y-0 left-0 z-40 w-72 bg-surface-200/90 backdrop-blur-xl border-r border-white/10 transition-transform duration-200 ${open ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
        <div className="p-4 border-b border-white/5 flex items-center justify-between">
          <div>
            <div className="text-[10px] uppercase tracking-[0.08em] text-gray-500">NeoAI</div>
            <div className="text-lg font-semibold text-white">SmolLM2 Chat</div>
          </div>
          <button
            onClick={onClose}
            className="lg:hidden w-9 h-9 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-surface-50 transition-colors"
            aria-label="Sidebar schlieÃŸen"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div className="p-4 space-y-4 h-[calc(100%-64px)] overflow-y-auto">
          <div className="space-y-2">
            <button
              onClick={() => { onNewSession(); onClose(); }}
              className="w-full flex items-center gap-2 px-3 py-2.5 rounded-xl bg-gradient-to-r from-accent-500 to-accent-600 text-white font-medium shadow-lg shadow-accent-500/30 hover:shadow-accent-500/50 transition-all"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
              </svg>
              Neuer Chat
            </button>
            <button
              onClick={onLoadModel}
              className="w-full flex items-center justify-between px-3 py-2.5 rounded-xl bg-surface-100 border border-white/10 text-sm text-gray-200 hover:border-white/20 transition-colors"
            >
              <div className="flex items-center gap-2">
                <span className="inline-flex w-2 h-2 rounded-full bg-emerald-400 animate-pulse" />
                <div className="text-left">
                  <div className="font-semibold text-white text-sm">SmolLM2-360M</div>
                  <div className="text-[11px] text-gray-500">ONNX q4f16 Â· ~273 MB</div>
                </div>
              </div>
              <span className={`text-[11px] px-2 py-0.5 rounded-full border ${modelStatus === 'ready' ? 'border-emerald-400/40 bg-emerald-500/10 text-emerald-100' : 'border-white/10 text-gray-400'}`}>
                {modelStatus === 'ready' ? 'Bereit' : 'Laden'}
              </span>
            </button>
            {modelCached && (
              <div className="flex items-center gap-2 text-[11px] text-emerald-200 bg-emerald-500/10 border border-emerald-500/20 px-3 py-2 rounded-lg">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
                Modell im Cache
              </div>
            )}
          </div>

          <div className="space-y-2">
            <div className="text-[11px] text-gray-500 px-1">VerlÃ¤ufe</div>
            <div className="space-y-1">
              {sessions.map((session) => (
                <button
                  key={session.id}
                  onClick={() => { onSessionChange(session.id); onClose(); }}
                  className={`w-full flex items-center gap-2 px-3 py-2.5 rounded-xl text-left transition-colors border ${session.id === currentSessionId ? 'border-accent-500/60 bg-accent-500/10 text-white' : 'border-white/5 bg-surface-100 hover:border-white/15 text-gray-200'}`}
                >
                  <svg className="w-4 h-4 shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                  <div className="flex-1 min-w-0">
                    <div className="text-sm font-medium truncate">{session.name}</div>
                    <div className="text-[10px] text-gray-500">{session.messages.length} Nachrichten</div>
                  </div>
                </button>
              ))}
              {!sessions.length && (
                <div className="text-xs text-gray-500 px-2 py-3 border border-dashed border-white/10 rounded-lg">
                  Noch keine VerlÃ¤ufe
                </div>
              )}
            </div>
          </div>

          <div className="space-y-3 border-t border-white/5 pt-3">
            <button
              onClick={onToggleWiki}
              className={`w-full flex items-center justify-between px-3 py-2.5 rounded-xl text-sm font-medium transition-colors border ${wikiEnabled ? 'border-indigo-500/40 bg-indigo-500/10 text-white' : 'border-white/10 bg-surface-100 text-gray-300 hover:border-white/20'}`}
            >
              <span className="flex items-center gap-2">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                Wikipedia an/aus
              </span>
              <span className={`text-[11px] px-2 py-0.5 rounded-full border ${wikiEnabled ? 'border-indigo-400/60 bg-indigo-500/20 text-indigo-100' : 'border-white/10 text-gray-400'}`}>
                {wikiEnabled ? 'Aktiv' : 'Aus'}
              </span>
            </button>
            <p className="text-[11px] text-gray-500 leading-relaxed">
              SmolLM2-360M Instruct lÃ¤uft lokal im Browser. Downloads nutzen die optimierte q4f16-ONNX-Variante, um HÃ¤nger zu vermeiden.
            </p>
          </div>
        </div>
      </aside>
    </>
  );
}

// Settings Modal
function SettingsModal({ isOpen, onClose, hfToken, onTokenChange, theme, onThemeChange, selectedModel, onModelChange }) {
  const [token, setToken] = useState(hfToken || '');
  const [showToken, setShowToken] = useState(false);
  const [localTheme, setLocalTheme] = useState(theme || 'dark');
  const [localModel, setLocalModel] = useState(selectedModel || DEFAULT_MODEL);

  useEffect(() => {
    setToken(hfToken || '');
    setLocalTheme(theme || 'dark');
    setLocalModel(selectedModel || DEFAULT_MODEL);
  }, [hfToken, theme, selectedModel]);

  const handleSave = () => {
    onTokenChange(token);
    onThemeChange(localTheme);
    onModelChange(localModel);
    onClose();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
      <div className="bg-surface-100 rounded-2xl shadow-2xl border border-white/10 max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold text-white">Einstellungen</h2>
          <button
            onClick={onClose}
            className="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-surface-200 text-gray-400 hover:text-white transition-colors"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div className="space-y-6">
          {/* Theme Toggle */}
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-3">
              Design
            </label>
            <div className="flex gap-3">
              <button
                onClick={() => setLocalTheme('dark')}
                className={`flex-1 px-4 py-3 rounded-xl border-2 transition-all ${localTheme === 'dark' ? 'border-accent-500 bg-accent-500/10' : 'border-white/10 hover:border-white/20'}`}
              >
                <div className="flex items-center justify-center gap-2 text-white">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                  </svg>
                  <span className="font-medium">Dunkel</span>
                </div>
              </button>
              <button
                onClick={() => setLocalTheme('light')}
                className={`flex-1 px-4 py-3 rounded-xl border-2 transition-all ${localTheme === 'light' ? 'border-accent-500 bg-accent-500/10' : 'border-white/10 hover:border-white/20'}`}
              >
                <div className="flex items-center justify-center gap-2 text-white">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                  <span className="font-medium">Hell</span>
                </div>
              </button>
            </div>
          </div>

          {/* Model Selection */}
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-3">
              KI-Modell
            </label>
            <div className="px-4 py-3 rounded-xl border-2 border-accent-500 bg-accent-500/10">
              <div className="flex items-start gap-3">
                <span className="text-2xl">ðŸŸ¢</span>
                <div className="flex-1">
                  <div className="font-semibold text-white">SmolLM2-360M</div>
                  <div className="text-xs text-gray-400">Festes Modell (HuggingFaceTB Â· ONNX q4f16)</div>
                  <div className="text-[10px] text-gray-500 mt-1">Download: ~273 MB</div>
                </div>
              </div>
            </div>
          </div>

          {/* HF Token */}
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-2">
              Hugging Face API Token
            </label>
            <p className="text-xs text-gray-400 mb-3">
              Optional: FÃ¼r den Zugriff auf geschÃ¼tzte Modelle. Token erhalten Sie auf{' '}
              <a href="https://huggingface.co/settings/tokens" target="_blank" rel="noopener noreferrer" className="text-accent-400 hover:underline">
                huggingface.co/settings/tokens
              </a>
            </p>
            <div className="relative">
              <input
                type={showToken ? 'text' : 'password'}
                value={token}
                onChange={(e) => setToken(e.target.value)}
                placeholder="hf_..."
                className="w-full px-3 py-2 bg-surface-200 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-accent-500 pr-10"
              />
              <button
                type="button"
                onClick={() => setShowToken(!showToken)}
                className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white"
              >
                {showToken ? (
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                  </svg>
                ) : (
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                )}
              </button>
            </div>
          </div>

          <div className="flex gap-2 pt-2">
            <button
              onClick={handleSave}
              className="flex-1 px-4 py-2 bg-gradient-to-br from-accent-500 to-accent-600 text-white rounded-lg font-medium hover:shadow-lg hover:shadow-accent-500/30 transition-all"
            >
              Speichern
            </button>
            <button
              onClick={onClose}
              className="px-4 py-2 bg-surface-200 text-gray-300 rounded-lg font-medium hover:bg-surface-50 transition-colors"
            >
              Abbrechen
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// Header
function Header({ modelStatus, runtimeStatus, modelCached, progress, onOpenSettings, onToggleSidebar }) {
  const runtimeChip = useMemo(() => {
    if (runtimeStatus === 'offline') return { label: 'Offline', classes: 'bg-red-500/20 text-red-200 border-red-500/30' };
    if (runtimeStatus === 'gpu') return { label: 'GPU aktiv', classes: 'bg-emerald-500/20 text-emerald-200 border-emerald-500/30' };
    return { label: 'CPU', classes: 'bg-amber-500/20 text-amber-100 border-amber-500/30' };
  }, [runtimeStatus]);

  const statusLabel = useMemo(() => {
    if (modelStatus === 'ready') return 'Modell bereit â€“ SmolLM2-360M';
    if (modelStatus === 'loading') return `Lade Modell ${progress > 0 ? `(${progress}%)` : ''}`;
    if (modelStatus === 'error') return 'Fehler beim Laden';
    return 'Modell noch nicht geladen';
  }, [modelStatus, progress]);

  return (
    <header className="flex items-center justify-between px-4 py-3 border-b border-white/10 bg-gradient-to-r from-surface-100/90 to-surface-200/90 backdrop-blur-xl sticky top-0 z-30 shadow-lg">
      <div className="flex items-center gap-3 min-w-0">
        <button
          onClick={onToggleSidebar}
          className="lg:hidden w-9 h-9 flex items-center justify-center rounded-xl border border-white/10 bg-surface-200/80 text-gray-300 hover:text-white hover:border-white/20"
          aria-label="Sidebar umschalten"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h10" />
          </svg>
        </button>
        <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-lg font-bold shrink-0 transition-all ${modelStatus === 'ready' ? 'bg-gradient-to-br from-accent-500 to-accent-600 text-white shadow-lg shadow-accent-500/30' : 'bg-gray-700/50 text-gray-400'}`}>
          N
        </div>
        <div className="min-w-0">
          <h1 className="text-sm font-bold text-white truncate tracking-tight">NeoAI â€¢ SmolLM2-360M</h1>
          <p className="text-[11px] text-gray-400 truncate flex items-center gap-1">
            {modelStatus === 'ready' ? (
              <span className="inline-flex items-center gap-1">
                <span className="inline-block w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse" />
                {statusLabel}
              </span>
            ) : modelStatus === 'loading' ? (
              <span className="inline-flex items-center gap-1">
                <span className="inline-block w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse" />
                {statusLabel}
              </span>
            ) : modelStatus === 'error' ? (
              <span className="inline-flex items-center gap-1">
                <span className="inline-block w-1.5 h-1.5 rounded-full bg-red-400" />
                {statusLabel}
              </span>
            ) : (
              <span className="inline-flex items-center gap-1">
                <span className="inline-block w-1.5 h-1.5 rounded-full bg-gray-500" />
                {statusLabel}
              </span>
            )}
          </p>
          <div className="flex items-center gap-2 mt-1">
            <span className={`px-2 py-1 rounded-full border text-[10px] font-medium ${runtimeChip.classes}`}>{runtimeChip.label}</span>
            {modelCached && (
              <span className="px-2 py-1 rounded-full border border-emerald-500/30 bg-emerald-500/10 text-emerald-100 text-[10px] font-medium">
                Cache OK
              </span>
            )}
          </div>
        </div>
      </div>
      <div className="flex items-center gap-2">
        <button
          onClick={onOpenSettings}
          className="w-9 h-9 flex items-center justify-center bg-surface-200/80 hover:bg-surface-50 rounded-xl transition-all text-gray-400 hover:text-white border border-white/5 hover:border-white/10"
          title="Einstellungen"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
      </div>
    </header>
  );
}

// Single Chat Message
function ChatMessage({ msg }) {
  const isUser = msg.role === 'user';
  const html = useMemo(() => isUser ? null : renderMarkdown(msg.content), [msg.content, isUser]);

  return (
    <div className={`msg-animate px-4 py-2 ${isUser ? '' : ''}`}>
      <div className={`max-w-3xl mx-auto flex ${isUser ? 'justify-end' : 'justify-start'} gap-2`}>
        {/* Avatar for AI only */}
        {!isUser && (
          <div className="w-8 h-8 shrink-0 rounded-full flex items-center justify-center text-xs font-semibold bg-gradient-to-br from-emerald-500 to-teal-600 text-white shadow-lg mt-1">
            AI
          </div>
        )}

        <div className={`flex flex-col ${isUser ? 'items-end' : 'items-start'} max-w-[85%]`}>
          {/* Wiki info badge */}
          {msg.wikiInfo && (
            <div className="mb-1 text-[10px] text-indigo-300 bg-indigo-500/20 px-2 py-0.5 rounded-full flex items-center gap-1 slide-in">
              <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
              </svg>
              Wikipedia: {msg.wikiInfo}
            </div>
          )}

          {/* Message bubble */}
          <div className={`message-bubble ${isUser ? 'user-bubble' : 'ai-bubble'}`}>
            {isUser ? (
              <p className="text-sm leading-relaxed whitespace-pre-wrap">{msg.content}</p>
            ) : (
              <div className="prose-chat text-sm" dangerouslySetInnerHTML={{ __html: html }} />
            )}
          </div>

          {/* Warning badge */}
          {msg.warning && (
            <div className="mt-1 text-[10px] text-amber-300 bg-amber-500/20 px-2 py-0.5 rounded-full flex items-center gap-1">
              <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd"/>
              </svg>
              {msg.warning}
            </div>
          )}
        </div>

        {/* Avatar for User only */}
        {isUser && (
          <div className="w-8 h-8 shrink-0 rounded-full flex items-center justify-center text-xs font-semibold bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-lg mt-1">
            Du
          </div>
        )}
      </div>
    </div>
  );
}

// Typing Indicator
function TypingIndicator({ wikiSearching }) {
  return (
    <div className="msg-animate px-4 py-2">
      <div className="max-w-3xl mx-auto flex justify-start gap-2">
        <div className="w-8 h-8 shrink-0 rounded-full flex items-center justify-center text-xs font-semibold bg-gradient-to-br from-emerald-500 to-teal-600 text-white shadow-lg mt-1">
          AI
        </div>
        <div className="flex flex-col items-start gap-2">
          {wikiSearching && (
            <div className="text-[10px] text-indigo-300 bg-indigo-500/20 px-2 py-0.5 rounded-full flex items-center gap-1">
              <svg className="animate-spin w-3 h-3" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
              </svg>
              Suche auf Wikipedia...
            </div>
          )}
          <div className="message-bubble ai-bubble flex gap-1.5 items-center h-6 px-4">
            <div className="typing-dot w-2 h-2 bg-gray-400 rounded-full" />
            <div className="typing-dot w-2 h-2 bg-gray-400 rounded-full" />
            <div className="typing-dot w-2 h-2 bg-gray-400 rounded-full" />
          </div>
        </div>
      </div>
    </div>
  );
}

// Welcome Screen
function WelcomeScreen({ modelStatus, onLoadModel }) {
  return (
    <div className="flex-1 flex items-center justify-center p-6">
      <div className="text-center max-w-2xl w-full">
        <div className="w-24 h-24 mx-auto mb-6 rounded-3xl bg-gradient-to-br from-accent-500 to-accent-600 flex items-center justify-center glow-pulse shadow-2xl shadow-accent-500/30">
          <span className="text-5xl font-bold text-white">N</span>
        </div>
        <h1 className="text-4xl font-bold text-white mb-3 tracking-tight">ChatGPT-Style mit SmolLM2</h1>
        <p className="text-base text-gray-400 mb-6 leading-relaxed max-w-lg mx-auto">
          Komplett lokal im Browser mit dem kompakten HuggingFaceTB/SmolLM2-360M-Instruct (ONNX q4f16). Ã–ffne die Sidebar links, um neue Chats zu starten oder den Wikipedia-Modus zu aktivieren.
        </p>

        {modelStatus === 'idle' && (
          <button
            onClick={onLoadModel}
            className="px-8 py-4 bg-gradient-to-r from-accent-500 to-accent-600 hover:from-accent-600 hover:to-accent-700 text-white text-base font-bold rounded-xl transition-all shadow-xl shadow-accent-500/30 hover:shadow-2xl hover:shadow-accent-500/40 hover:scale-105"
          >
            SmolLM2-360M laden
          </button>
        )}

        {modelStatus === 'loading' && (
          <div className="space-y-4">
            <div className="h-3 w-80 max-w-full mx-auto rounded-full overflow-hidden bg-gray-700/50 border border-white/5">
              <div className="shimmer-bar h-full rounded-full" />
            </div>
            <p className="text-sm text-gray-400">
              SmolLM2-360M wird heruntergeladenâ€¦
            </p>
            <p className="text-xs text-gray-500">
              Optimierte ONNX q4f16 â€¢ ~273 MB
            </p>
          </div>
        )}

        {modelStatus === 'ready' && (
          <div className="space-y-4">
            <div className="flex items-center justify-center gap-3 text-emerald-400">
              <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span className="text-lg font-semibold">SmolLM2-360M bereit!</span>
            </div>
            <p className="text-sm text-gray-400">
              Starte links einen Chat oder schreib direkt los.
            </p>
          </div>
        )}

        {modelStatus === 'error' && (
          <div className="space-y-4 max-w-lg mx-auto">
            <div className="flex items-center justify-center gap-3 text-red-400">
              <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <span className="text-lg font-semibold">WebGPU nicht verfÃ¼gbar</span>
            </div>
            <div className="text-sm text-gray-300 text-left bg-white/5 p-4 rounded-xl border border-white/10 space-y-3">
              <p className="font-semibold text-white">iPad-Nutzer (Safari):</p>
              <ol className="list-decimal list-inside space-y-2 text-xs">
                <li>Ã–ffne <strong>Einstellungen</strong> auf deinem iPad</li>
                <li>Gehe zu <strong>Safari â†’ Erweitert</strong></li>
                <li>Aktiviere <strong>Experimentelle Features</strong></li>
                <li>Aktiviere <strong>WebGPU</strong></li>
                <li>Starte Safari neu und lade diese Seite erneut</li>
              </ol>
              <p className="text-[10px] text-gray-400 mt-2">
                WebGPU ist erforderlich fÃ¼r die Hardware-beschleunigte KI-Inferenz.
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// Progress Bar
function ProgressBar({ progress }) {
  if (progress <= 0) return null;
  return (
    <div className="px-4 py-2 bg-surface-200/80 border-b border-white/5">
      <div className="max-w-3xl mx-auto">
        <div className="h-1.5 bg-gray-700/50 rounded-full overflow-hidden border border-white/5">
          <div className="h-full bg-gradient-to-r from-accent-500 to-accent-600 rounded-full transition-all duration-300 shadow-lg" style={{ width: `${progress}%` }} />
        </div>
        <p className="text-[10px] text-gray-400 mt-1.5 flex items-center justify-between">
          <span>Modell laden...</span>
          <span className="font-semibold text-accent-400">{progress}%</span>
        </p>
      </div>
    </div>
  );
}

// Input Bar
function InputBar({ onSend, disabled, wikiEnabled, onToggleWiki, wikiNotice }) {
  const [text, setText] = useState('');
  const textareaRef = useRef(null);

  const handleSubmit = (e) => {
    e?.preventDefault();
    const trimmed = text.trim();
    if (!trimmed || disabled) return;
    onSend(trimmed);
    setText('');
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit();
    }
  };

  const handleInput = (e) => {
    setText(e.target.value);
    e.target.style.height = 'auto';
    e.target.style.height = Math.min(e.target.scrollHeight, 150) + 'px';
  };

  return (
    <form onSubmit={handleSubmit} className="border-t border-white/10 bg-gradient-to-r from-surface-100/90 to-surface-200/90 backdrop-blur-xl px-4 py-3 shadow-lg">
      <div className="max-w-3xl mx-auto">
        <div className="flex gap-2 items-end">
          <textarea
            ref={textareaRef}
            value={text}
            onChange={handleInput}
            onKeyDown={handleKeyDown}
            placeholder={disabled ? 'Modell wird geladen...' : 'Nachricht eingeben...'}
            disabled={disabled}
            rows={1}
            className="flex-1 bg-surface-200/80 text-sm text-white placeholder-gray-500 rounded-2xl px-5 py-3 resize-none outline-none focus:ring-2 focus:ring-accent-500/50 border border-white/10 disabled:opacity-40 transition-all"
          />
          <button
            type="button"
            onClick={onToggleWiki}
            className={`shrink-0 px-3 h-11 flex items-center justify-center gap-2 rounded-xl text-xs font-medium transition-all ${wikiEnabled ? 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-lg shadow-indigo-500/30' : 'bg-surface-200/80 text-gray-400 hover:bg-surface-50 border border-white/10'}`}
            title="Wissen vertiefen"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            Wissen vertiefen
          </button>
          <button
            type="submit"
            disabled={disabled || !text.trim()}
            className="shrink-0 w-11 h-11 flex items-center justify-center bg-gradient-to-br from-accent-500 to-accent-600 hover:from-accent-600 hover:to-accent-700 disabled:from-gray-700 disabled:to-gray-700 disabled:text-gray-500 text-white rounded-xl transition-all shadow-lg disabled:shadow-none"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
        <div className="flex items-center justify-between mt-2 px-1">
          <p className="text-[10px] text-gray-500">
            NeoAI kann Fehler machen. Kompaktes lokales Modell.
          </p>
          <div className="flex items-center gap-2">
            {wikiEnabled && (
              <p className="text-[10px] text-indigo-400 flex items-center gap-1">
                <span className="inline-block w-1.5 h-1.5 rounded-full bg-indigo-400"></span>
                Wikipedia aktiv
              </p>
            )}
            {wikiNotice && (
              <p className="text-[10px] text-amber-300 flex items-center gap-1">
                <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd"/>
                </svg>
                {wikiNotice}
              </p>
            )}
          </div>
        </div>
      </div>
    </form>
  );
}

// â”€â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [sessions, setSessions] = useState([]);
  const [sessionsReady, setSessionsReady] = useState(false);
  const [currentSessionId, setCurrentSessionId] = useState(null);
  const [modelStatus, setModelStatus] = useState('idle'); // idle | loading | ready | error
  const [runtimeStatus, setRuntimeStatus] = useState('checking'); // gpu | cpu | offline
  const [modelCached, setModelCached] = useState(false);
  const [progress, setProgress] = useState(0);
  const [isGenerating, setIsGenerating] = useState(false);
  const [wikiSearching, setWikiSearching] = useState(false);
  const [wikiEnabled, setWikiEnabled] = useState(() => loadSettings().wikiEnabled ?? false);
  const [wikiNotice, setWikiNotice] = useState('');
  const [hfToken, setHfToken] = useState(() => loadSettings().hfToken || '');
  const [theme, setTheme] = useState(() => loadSettings().theme || 'dark');
  const [selectedModel, setSelectedModel] = useState(() => loadSettings().selectedModel || DEFAULT_MODEL);
  const [showSettings, setShowSettings] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(() => (typeof window !== 'undefined' ? window.innerWidth >= 1024 : true));
  const workerRef = useRef(null);
  const scrollRef = useRef(null);
  const msgIdCounter = useRef(0);

  const currentSession = sessions.find(s => s.id === currentSessionId) || sessions[0];
  const messages = currentSession?.messages || [];

  // Load sessions from IndexedDB
  useEffect(() => {
    let active = true;
    (async () => {
      const stored = await loadSessionsFromDB();
      const list = stored.length ? stored : [createDefaultSession()];
      if (!active) return;
      setSessions(list);
      setCurrentSessionId(list[0].id);
      setSessionsReady(true);
    })();
    return () => { active = false; };
  }, []);

  // Persist sessions
  useEffect(() => {
    if (!sessionsReady || !sessions.length) return;
    saveSessionsToDB(sessions);
  }, [sessions, sessionsReady]);

  // Persist settings
  useEffect(() => {
    saveSettings({ wikiEnabled, hfToken, theme, selectedModel });
  }, [wikiEnabled, hfToken, theme, selectedModel]);

  // Apply theme to body
  useEffect(() => {
    document.body.className = theme;
  }, [theme]);

  // Track runtime status (GPU/CPU/Offline)
  const updateRuntimeStatus = useCallback(async () => {
    if (!navigator.onLine) {
      setRuntimeStatus('offline');
      return;
    }
    const gpu = await checkWebGPU();
    setRuntimeStatus(gpu ? 'gpu' : 'cpu');
  }, []);

  useEffect(() => {
    updateRuntimeStatus();
    const handleOnline = () => updateRuntimeStatus();
    const handleOffline = () => setRuntimeStatus('offline');
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, [updateRuntimeStatus]);

  // Check model cache marker
  useEffect(() => {
    isModelCached(selectedModel).then(setModelCached);
  }, [selectedModel]);

  // RAM management: Cleanup on tab close/hide and inactivity
  useEffect(() => {
    let inactivityTimer = null;

    // Cleanup on page unload (tab close)
    const handleUnload = () => {
      if (workerRef.current) {
        unloadModel(workerRef.current);
        workerRef.current = null;
      }
    };

    // Cleanup on page visibility change (tab switch/hide)
    const handleVisibilityChange = () => {
      if (document.hidden) {
        // Check memory status when tab is hidden
        if (isLowMemory()) {
          console.log('Low memory detected, unloading model');
          if (workerRef.current) {
            unloadModel(workerRef.current);
            workerRef.current = null;
            setModelStatus('idle');
          }
        }
      }
    };

    // Cleanup after 10 minutes of inactivity
    const resetInactivityTimer = () => {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        if (workerRef.current && !isGenerating) {
          console.log('Unloading model due to inactivity');
          unloadModel(workerRef.current);
          workerRef.current = null;
          setModelStatus('idle');
        }
      }, 600000); // 10 minutes
    };

    window.addEventListener('beforeunload', handleUnload);
    document.addEventListener('visibilitychange', handleVisibilityChange);
    document.addEventListener('mousedown', resetInactivityTimer);
    document.addEventListener('keydown', resetInactivityTimer);
    document.addEventListener('touchstart', resetInactivityTimer);

    resetInactivityTimer();

    return () => {
      window.removeEventListener('beforeunload', handleUnload);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      document.removeEventListener('mousedown', resetInactivityTimer);
      document.removeEventListener('keydown', resetInactivityTimer);
      document.removeEventListener('touchstart', resetInactivityTimer);
      if (inactivityTimer) clearTimeout(inactivityTimer);
    };
  }, [isGenerating]);

  // Auto-scroll
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages, isGenerating]);

  // Initialize worker
  const initWorker = useCallback(() => {
    if (workerRef.current) workerRef.current.terminate();
    const w = createWorker();
    w.onmessage = (e) => {
      const d = e.data;
      if (d.type === 'status') {
        if (d.stage === 'loading') setModelStatus('loading');
        if (d.stage === 'ready') {
          setModelStatus('ready');
          setProgress(100);
          markModelCached(selectedModel).then(() => setModelCached(true));
          setTimeout(() => setProgress(0), 1000);
        }
      } else if (d.type === 'progress') {
        setProgress(d.progress);
      } else if (d.type === 'result') {
        setSessions(prev => {
          const updated = prev.map(s =>
            s.id === currentSessionId
              ? { ...s, messages: [...s.messages, { role: 'assistant', content: d.text || '(Keine Antwort)', id: d.id }], updatedAt: Date.now() }
              : s
          );
          return updated;
        });
        setIsGenerating(false);
      } else if (d.type === 'error') {
        setSessions(prev => {
          const updated = prev.map(s =>
            s.id === currentSessionId
              ? { ...s, messages: [...s.messages, { role: 'assistant', content: 'âš  Fehler: ' + d.message, id: d.id }], updatedAt: Date.now() }
              : s
          );
          return updated;
        });
        setIsGenerating(false);
        if (d.message?.includes('Laden')) setModelStatus('error');
        // Clear cache if instructed
        if (d.shouldClearCache) {
          clearModelCache().then(() => {
            console.log('Cache cleared after error');
            setModelCached(false);
          });
        }
      }
    };
    w.onerror = () => {
      setModelStatus('error');
      setIsGenerating(false);
    };
    workerRef.current = w;
    // Send HF token to worker on initialization
    if (hfToken) {
      w.postMessage({ type: 'setToken', token: hfToken });
    }
    return w;
  }, [currentSessionId, hfToken, selectedModel]);

  // Send HF token to worker when it changes or worker is initialized
  useEffect(() => {
    if (workerRef.current && hfToken) {
      workerRef.current.postMessage({ type: 'setToken', token: hfToken });
    }
  }, [hfToken]);

  // Load model
  const loadModel = useCallback(async () => {
    setModelStatus('loading');
    const cached = await isModelCached(selectedModel);
    setModelCached(cached);
    setProgress(cached ? 100 : 0);
    const w = workerRef.current || initWorker();
    w.postMessage({ type: 'load', modelId: selectedModel });
  }, [initWorker, selectedModel]);

  const toggleWiki = useCallback(() => {
    if (!navigator.onLine) {
      setWikiEnabled(false);
      setWikiNotice('Offline â€“ Wikipedia braucht WLAN');
      return;
    }
    setWikiNotice('');
    setWikiEnabled((prev) => !prev);
  }, []);

  // Send message
  const sendMessage = useCallback(async (text) => {
    if (isGenerating || !currentSessionId) return;

    // If model not ready, start loading first
    if (modelStatus !== 'ready') {
      loadModel();
      // Queue the message after a brief delay to let the model load
    }

    const userMsg = { role: 'user', content: text, id: Date.now() };
    setSessions(prev => {
      const updated = prev.map(s =>
        s.id === currentSessionId
          ? { ...s, messages: [...s.messages, userMsg], updatedAt: Date.now() }
          : s
      );
      return updated;
    });
    setIsGenerating(true);

    let wikiContext = null;
    let wikiTitle = null;
    let warning = null;
    setWikiNotice('');

    // Wikipedia RAG
    if (wikiEnabled) {
      if (!navigator.onLine) {
        warning = 'Offline â€“ Wikipedia nur mit WLAN';
        setWikiNotice('Offline â€“ Wikipedia nur mit WLAN');
        setWikiSearching(false);
      } else {
        setWikiSearching(true);
        try {
          const result = await searchWikipedia(text);
          if (result) {
            wikiContext = result.text;
            wikiTitle = result.title;
          } else {
            warning = 'Keine Wikipedia-Treffer gefunden';
          }
        } catch (err) {
          warning = 'Kein Internet â€” nutze lokales Wissen';
          setWikiNotice('Wikipedia nicht erreichbar');
        }
        setWikiSearching(false);
      }
    }

    // Build messages for the model
    const systemPrompt = wikiContext
      ? `Du bist NeoAI, ein hilfreicher KI-Assistent. Nutze folgenden Kontext von Wikipedia, um die Frage zu beantworten. Antworte auf Deutsch.\n\n--- Wikipedia: ${wikiTitle} ---\n${wikiContext}\n--- Ende Kontext ---`
      : 'Du bist NeoAI, ein hilfreicher KI-Assistent. Antworte klar, prÃ¤zise und auf Deutsch.';

    // Take last 10 messages for context window (Liquid architecture handles more context)
    const currentMessages = [...messages, userMsg];
    const recentMsgs = currentMessages.slice(-10);
    const chatMessages = [
      { role: 'system', content: systemPrompt },
      ...recentMsgs.map(m => ({ role: m.role, content: m.content }))
    ];

    const id = ++msgIdCounter.current;

    // If worker not initialized, create it
    if (!workerRef.current) initWorker();

    // Store wiki info for display
    const origOnMessage = workerRef.current.onmessage;
    workerRef.current.onmessage = (e) => {
      const d = e.data;
      if (d.type === 'result' && d.id === id) {
        const aiMsg = {
          role: 'assistant',
          content: d.text || '(Keine Antwort)',
          id: d.id,
          wikiInfo: wikiTitle ? `${wikiTitle}` : undefined,
          warning: warning || undefined
        };
        setSessions(prev => {
          const updated = prev.map(s =>
            s.id === currentSessionId
              ? { ...s, messages: [...s.messages, aiMsg], updatedAt: Date.now() }
              : s
          );
          return updated;
        });
        setIsGenerating(false);
      } else if (d.type === 'error' && d.id === id) {
        setSessions(prev => {
          const updated = prev.map(s =>
            s.id === currentSessionId
              ? { ...s, messages: [...s.messages, { role: 'assistant', content: 'âš  Fehler: ' + d.message, id: d.id, warning }], updatedAt: Date.now() }
              : s
          );
          return updated;
        });
        setIsGenerating(false);
        // Clear cache if instructed
        if (d.shouldClearCache) {
          clearModelCache().then(() => {
            console.log('Cache cleared after generation error');
            setModelCached(false);
          });
        }
      } else if (d.type === 'status') {
        if (d.stage === 'loading') setModelStatus('loading');
        if (d.stage === 'ready') {
          setModelStatus('ready');
          setProgress(100);
          markModelCached(selectedModel).then(() => setModelCached(true));
          setTimeout(() => setProgress(0), 1000);
        }
      } else if (d.type === 'progress') {
        setProgress(d.progress);
      }
    };

    workerRef.current.postMessage({
      type: 'generate',
      modelId: selectedModel,
      messages: chatMessages,
      id
    });
  }, [messages, isGenerating, wikiEnabled, modelStatus, initWorker, loadModel, currentSessionId, selectedModel]);

  // Clear chat
  const clearChat = useCallback(() => {
    setSessions(prev => {
      const updated = prev.map(s =>
        s.id === currentSessionId
          ? { ...s, messages: [], updatedAt: Date.now() }
          : s
      );
      return updated;
    });
  }, [currentSessionId]);

  // Session management
  const createNewSession = useCallback(() => {
    setSessions(prev => {
      const newSession = createDefaultSession(`Chat ${prev.length + 1}`);
      setCurrentSessionId(newSession.id);
      return [...prev, newSession];
    });
  }, []);

  const switchSession = useCallback((sessionId) => {
    setCurrentSessionId(sessionId);
  }, []);

  const hasMessages = messages.length > 0;
  const closeSidebar = useCallback(() => {
    if (typeof window !== 'undefined' && window.innerWidth >= 1024) {
      setSidebarOpen(true);
      return;
    }
    setSidebarOpen(false);
  }, []);

  return (
    <div className="h-dvh flex bg-surface-300 text-white">
      <Sidebar
        open={sidebarOpen}
        onClose={closeSidebar}
        sessions={sessions}
        currentSessionId={currentSessionId}
        onSessionChange={switchSession}
        onNewSession={createNewSession}
        wikiEnabled={wikiEnabled}
        onToggleWiki={toggleWiki}
        modelStatus={modelStatus}
        modelCached={modelCached}
        onLoadModel={loadModel}
      />

      <div className="flex-1 flex flex-col min-w-0">
        <SettingsModal
          isOpen={showSettings}
          onClose={() => setShowSettings(false)}
          hfToken={hfToken}
          onTokenChange={setHfToken}
          theme={theme}
          onThemeChange={setTheme}
          selectedModel={selectedModel}
          onModelChange={setSelectedModel}
        />
        <Header
          modelStatus={modelStatus}
          runtimeStatus={runtimeStatus}
          modelCached={modelCached}
          progress={progress}
          onOpenSettings={() => setShowSettings(true)}
          onToggleSidebar={() => setSidebarOpen((prev) => !prev)}
        />

        {modelStatus === 'loading' && <ProgressBar progress={progress} />}

        {/* Chat area */}
        <div ref={scrollRef} className="flex-1 overflow-y-auto">
          {!hasMessages && !isGenerating ? (
            <WelcomeScreen
              modelStatus={modelStatus}
              onLoadModel={loadModel}
            />
          ) : (
            <div className="pb-2">
              {messages.map((msg, i) => (
                <ChatMessage key={msg.id || i} msg={msg} />
              ))}
              {isGenerating && <TypingIndicator wikiSearching={wikiSearching} />}
            </div>
          )}
        </div>

        {/* Clear button when messages exist */}
        {hasMessages && (
          <div className="flex justify-center py-2 bg-surface-300 border-t border-white/5">
            <button
              onClick={clearChat}
              className="text-[11px] text-gray-500 hover:text-gray-300 transition-colors px-4 py-1.5 rounded-lg hover:bg-white/5"
            >
              Chat lÃ¶schen
            </button>
          </div>
        )}

        <InputBar
          onSend={sendMessage}
          disabled={isGenerating}
          wikiEnabled={wikiEnabled}
          onToggleWiki={toggleWiki}
          wikiNotice={wikiNotice}
        />
      </div>
    </div>
  );
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

// â”€â”€â”€ Service Worker Registration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // Create service worker inline
    const swCode = `
      const CACHE_NAME = 'neoai-v1';
      const urlsToCache = [
        './',
        './index.html'
      ];

      self.addEventListener('install', (event) => {
        event.waitUntil(
          caches.open(CACHE_NAME)
            .then((cache) => cache.addAll(urlsToCache))
        );
      });

      self.addEventListener('fetch', (event) => {
        if (event.request.method !== 'GET') return;
        event.respondWith(
          caches.match(event.request)
            .then((response) => {
              if (response) return response;
              return fetch(event.request).then((networkResponse) => {
                const copy = networkResponse.clone();
                caches.open(CACHE_NAME).then((cache) => cache.put(event.request, copy));
                return networkResponse;
              }).catch(() => caches.match(event.request));
            })
        );
      });

      self.addEventListener('activate', (event) => {
        event.waitUntil(
          caches.keys().then((cacheNames) => {
            return Promise.all(
              cacheNames.map((cacheName) => {
                if (cacheName !== CACHE_NAME) {
                  return caches.delete(cacheName);
                }
              })
            );
          })
        );
      });
    `;

    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);

    navigator.serviceWorker.register(swUrl)
      .then((registration) => {
        console.log('Service Worker registered:', registration);
      })
      .catch((error) => {
        console.log('Service Worker registration failed:', error);
      });
  });
}

// â”€â”€â”€ WebGPU Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkWebGPU() {
  if (!navigator.gpu) {
    console.warn('WebGPU nicht verfÃ¼gbar');
    return false;
  }
  try {
    const adapter = await navigator.gpu.requestAdapter();
    return !!adapter;
  } catch (e) {
    console.warn('WebGPU Adapter konnte nicht angefordert werden:', e);
    return false;
  }
}

// Check WebGPU on load
checkWebGPU().then(available => {
  if (!available) {
    console.warn('WebGPU ist nicht aktiviert. iPad-Nutzer sollten in Safari > Einstellungen > Erweitert > Experimentelle Features > WebGPU aktivieren.');
  }
});

</script>

</body>
</html>
