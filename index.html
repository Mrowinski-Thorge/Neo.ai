<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoAI • Private Local Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: '#09090b', // Zinc 950 - Sehr dunkles Grau/Schwarz
                        surface: '#18181b',    // Zinc 900
                        surface_highlight: '#27272a', // Zinc 800
                        primary: '#fafafa',    // Fast Weiß für Text
                        secondary: '#a1a1aa',  // Zinc 400 für Subtext
                        accent: '#3b82f6',     // Blau
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Marked.js & DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base Setup */
        body {
            background-color: theme('colors.background');
            color: theme('colors.primary');
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Frosted Glass Utilities */
        .glass {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-strong {
            background: rgba(9, 9, 11, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* Markdown Styles Cleaner */
        .prose p { margin-bottom: 0.75em; line-height: 1.6; }
        .prose p:last-child { margin-bottom: 0; }
        .prose pre {
            background-color: #0f0f12; /* Darker than surface */
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #27272a;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .prose code {
            color: #e4e4e7;
            background-color: rgba(255,255,255,0.1);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .prose pre code { background-color: transparent; padding: 0; color: inherit; }
        
        /* Typing Cursor */
        .typing-cursor::after {
            content: '';
            display: inline-block;
            width: 6px;
            height: 16px;
            background-color: currentColor;
            margin-left: 4px;
            vertical-align: middle;
            animation: blink 1s step-start infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Dialog Animation */
        dialog { transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; transform: scale(0.95); }
        dialog[open] { opacity: 1; transform: scale(1); }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden selection:bg-blue-500/30">

    <!-- Confirmation Modal (Custom Overlay) -->
    <dialog id="confirm-modal" class="glass-strong text-primary p-0 rounded-2xl shadow-2xl border border-white/10 max-w-sm w-full z-[100]">
        <div class="p-6 text-center">
            <div class="mx-auto w-12 h-12 bg-red-500/10 rounded-full flex items-center justify-center mb-4 text-red-400">
                <i data-lucide="alert-triangle"></i>
            </div>
            <h3 id="confirm-title" class="text-lg font-semibold mb-2">Bist du sicher?</h3>
            <p id="confirm-msg" class="text-secondary text-sm mb-6">Diese Aktion kann nicht rückgängig gemacht werden.</p>
            <div class="flex gap-3 justify-center">
                <button id="confirm-cancel" class="px-5 py-2 rounded-xl text-sm font-medium hover:bg-white/5 transition">Abbrechen</button>
                <button id="confirm-ok" class="px-5 py-2 bg-red-600 hover:bg-red-500 text-white rounded-xl text-sm font-medium transition shadow-lg shadow-red-500/20">Bestätigen</button>
            </div>
        </div>
    </dialog>

    <!-- Mobile Header (Glass) -->
    <div class="md:hidden fixed top-0 left-0 right-0 h-16 glass z-50 flex items-center justify-between px-4">
        <button id="menu-btn" class="p-2 text-secondary hover:text-primary transition"><i data-lucide="menu"></i></button>
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]"></div>
            <span class="font-bold tracking-tight">NeoAI</span>
        </div>
        <button id="new-chat-mobile" class="p-2 text-secondary hover:text-primary transition"><i data-lucide="plus"></i></button>
    </div>

    <!-- Sidebar (Glass on Desktop) -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-[280px] bg-black/50 sidebar-glass md:bg-transparent md:glass border-r border-white/5 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 pt-16 md:pt-0">
        <div class="p-5 hidden md:flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white/5 rounded-lg flex items-center justify-center border border-white/10">
                    <i data-lucide="cpu" class="w-5 h-5 text-white"></i>
                </div>
                <span class="font-bold text-lg tracking-tight">NeoAI</span>
            </div>
            <button id="new-chat-btn" class="p-2 bg-white/5 hover:bg-white/10 rounded-lg transition border border-white/5" title="Neuer Chat">
                <i data-lucide="plus" class="w-4 h-4"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-3 space-y-1 py-2" id="chat-history-list">
            <!-- Chat Items -->
        </div>

        <div class="p-4 border-t border-white/5">
            <button id="settings-btn" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-sm text-secondary hover:text-primary transition">
                <i data-lucide="settings" class="w-4 h-4"></i>
                <span>Einstellungen</span>
            </button>
        </div>
    </aside>

    <!-- Mobile Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-30 opacity-0 pointer-events-none transition-opacity duration-300 md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative w-full h-full pt-16 md:pt-0">
        
        <!-- INTRO / ONBOARDING SCREEN -->
        <div id="intro-screen" class="absolute inset-0 z-20 flex flex-col items-center justify-center p-6 bg-background space-y-8 glass-strong">
            <div class="relative w-24 h-24 mb-4 animate-float">
                <div class="absolute inset-0 bg-blue-500/20 rounded-full blur-xl"></div>
                <div class="relative w-full h-full bg-white/5 border border-white/10 rounded-2xl flex items-center justify-center backdrop-blur-md shadow-2xl">
                    <i data-lucide="zap" class="w-10 h-10 text-white"></i>
                </div>
            </div>
            
            <div class="text-center max-w-lg space-y-4">
                <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-b from-white to-gray-500 bg-clip-text text-transparent tracking-tight">
                    NeoAI Local
                </h1>
                <p class="text-secondary text-lg leading-relaxed">
                    Echte KI, die vollständig auf deinem Gerät läuft.<br>
                    Keine Cloud. Kein Tracking. 100% Privat.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-lg mt-4">
                <div class="p-4 rounded-2xl bg-white/5 border border-white/5 flex flex-col items-center text-center">
                    <i data-lucide="wifi-off" class="w-6 h-6 mb-2 text-gray-400"></i>
                    <span class="font-medium">Offline Ready</span>
                    <span class="text-xs text-gray-500">Funktioniert ohne Internet</span>
                </div>
                <div class="p-4 rounded-2xl bg-white/5 border border-white/5 flex flex-col items-center text-center">
                    <i data-lucide="database" class="w-6 h-6 mb-2 text-gray-400"></i>
                    <span class="font-medium">WebGPU</span>
                    <span class="text-xs text-gray-500">Hardware-beschleunigt</span>
                </div>
            </div>

            <button id="start-onboarding-btn" class="group mt-8 px-8 py-4 bg-white text-black rounded-full text-lg font-bold hover:bg-gray-200 transition-all shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:shadow-[0_0_30px_rgba(255,255,255,0.5)] flex items-center gap-2">
                Jetzt Starten
                <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
            </button>
            <p class="text-xs text-secondary/50 max-w-xs text-center">
                Durch Klicken stimmst du dem Download des Modells (~1GB) auf dein Gerät zu.
            </p>
        </div>

        <!-- LOADING SCREEN -->
        <div id="loading-screen" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center bg-background glass-strong">
            <div class="w-full max-w-md p-8 space-y-6">
                <div class="flex justify-between items-end mb-2">
                    <h3 class="text-xl font-bold text-white">Modell wird geladen</h3>
                    <span id="loading-percentage" class="text-2xl font-mono text-blue-400">0%</span>
                </div>
                
                <!-- Progress Bar Container -->
                <div class="relative h-2 bg-white/10 rounded-full overflow-hidden">
                    <div id="loading-bar" class="absolute top-0 left-0 h-full bg-blue-500 transition-all duration-300 w-0 shadow-[0_0_10px_#3b82f6]"></div>
                </div>
                
                <div class="space-y-2">
                    <div id="loading-step-download" class="flex items-center gap-3 text-sm text-secondary opacity-50 transition-opacity">
                        <div class="w-4 h-4 rounded-full border border-current flex items-center justify-center text-[10px]">1</div>
                        <span>Dateien herunterladen (~500MB compressed)</span>
                    </div>
                    <div id="loading-step-gpu" class="flex items-center gap-3 text-sm text-secondary opacity-50 transition-opacity">
                        <div class="w-4 h-4 rounded-full border border-current flex items-center justify-center text-[10px]">2</div>
                        <span>In den GPU-Speicher laden</span>
                    </div>
                </div>

                <p id="loading-detail" class="text-xs font-mono text-secondary/50 text-center pt-4">Initialisiere Umgebung...</p>
                
                <div class="flex justify-center pt-8">
                     <button id="cancel-load-btn" class="text-red-400 text-sm hover:underline">Abbrechen</button>
                </div>
            </div>
        </div>

        <!-- CHAT INTERFACE -->
        <div id="chat-interface" class="flex-1 flex flex-col hidden h-full">
            <!-- Messages Area with Padding to avoid being behind header/footer -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 scroll-smooth max-w-3xl mx-auto w-full">
                <!-- Empty State within chat -->
                <div id="empty-chat-placeholder" class="h-full flex flex-col items-center justify-center text-center space-y-4 opacity-50">
                    <i data-lucide="message-square" class="w-12 h-12 text-secondary"></i>
                    <p class="text-secondary">Schreibe eine Nachricht, um zu beginnen.</p>
                </div>
            </div>

            <!-- Input Area (Floating Style) -->
            <div class="p-4 md:p-6 w-full max-w-3xl mx-auto">
                <div class="relative glass rounded-3xl p-2 shadow-2xl border border-white/5 transition-all focus-within:border-white/20 focus-within:ring-1 focus-within:ring-white/10">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="Schreibe etwas..." 
                        class="w-full bg-transparent text-primary placeholder-secondary/50 text-base px-4 py-3 focus:outline-none resize-none max-h-48"
                        style="min-height: 52px;"
                    ></textarea>
                    
                    <div class="flex items-center justify-between px-2 pb-1">
                        <div class="text-xs text-secondary/40 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                            <span>Model Ready</span>
                        </div>
                        <button 
                            id="send-btn" 
                            class="p-2.5 bg-white text-black rounded-xl hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
                        >
                            <i data-lucide="arrow-up" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <dialog id="settings-modal" class="glass-strong text-primary p-0 rounded-2xl shadow-2xl border border-white/10 max-w-md w-full backdrop:bg-black/80">
        <div class="p-6">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-xl font-bold">Einstellungen</h2>
                <button id="close-settings" class="p-1 hover:bg-white/10 rounded-lg transition"><i data-lucide="x"></i></button>
            </div>

            <div class="space-y-6">
                <div class="bg-white/5 border border-white/5 rounded-xl p-4">
                    <h3 class="font-semibold mb-1 text-sm text-gray-300">Speicherverwaltung</h3>
                    <p class="text-xs text-secondary mb-4">Verwalte deine lokalen Daten.</p>
                    
                    <div class="space-y-3">
                        <button id="delete-history-btn" class="w-full flex items-center justify-between px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm transition group">
                            <span>Alle Chats löschen</span>
                            <i data-lucide="trash" class="w-4 h-4 text-secondary group-hover:text-red-400 transition"></i>
                        </button>
                        <button id="delete-model-btn" class="w-full flex items-center justify-between px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm transition group">
                            <span>Modell-Daten löschen</span>
                            <i data-lucide="database" class="w-4 h-4 text-secondary group-hover:text-red-400 transition"></i>
                        </button>
                    </div>
                </div>

                <div class="text-[10px] text-secondary/30 text-center font-mono">
                    NeoAI v1.2 • Local Qwen2.5-0.5B • WebGPU
                </div>
            </div>
        </div>
    </dialog>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0-alpha.19';

        lucide.createIcons();

        // --- Config ---
        env.allowLocalModels = false;
        env.useBrowserCache = true;
        const MODEL_ID = 'Qwen/Qwen2.5-0.5B-Instruct';

        // --- State ---
        const state = {
            chats: [],
            currentChatId: null,
            isGenerating: false,
            modelReady: false,
        };

        // --- DOM Elements ---
        const UI = {
            screens: {
                intro: document.getElementById('intro-screen'),
                loading: document.getElementById('loading-screen'),
                chat: document.getElementById('chat-interface'),
            },
            modals: {
                settings: document.getElementById('settings-modal'),
                confirm: document.getElementById('confirm-modal'),
            },
            input: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            chatContainer: document.getElementById('chat-container'),
            historyList: document.getElementById('chat-history-list'),
            placeholder: document.getElementById('empty-chat-placeholder'),
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('sidebar-overlay'),
            confirm: {
                title: document.getElementById('confirm-title'),
                msg: document.getElementById('confirm-msg'),
                cancel: document.getElementById('confirm-cancel'),
                ok: document.getElementById('confirm-ok'),
            },
            loading: {
                bar: document.getElementById('loading-bar'),
                percent: document.getElementById('loading-percentage'),
                stepDownload: document.getElementById('loading-step-download'),
                stepGpu: document.getElementById('loading-step-gpu'),
                detail: document.getElementById('loading-detail'),
            }
        };

        // --- Core Application Flow ---

        async function initApp() {
            loadChats();
            
            // Check localStorage for onboarding flag
            const onboardingDone = localStorage.getItem('neoai_onboarding_completed') === 'true';

            if (!onboardingDone) {
                // Show Intro
                switchScreen('intro');
            } else {
                // Skip intro, go to chat, load model in background or on demand
                // User requirement: "loading screen model, loads then comes main screen"
                // So we do the loading sequence every time to ensure model is ready in RAM
                 switchScreen('loading');
                 startModelLoading();
            }
        }

        function switchScreen(screenName) {
            Object.values(UI.screens).forEach(el => el.classList.add('hidden'));
            UI.screens[screenName].classList.remove('hidden');
        }

        // --- Onboarding & Loading ---

        document.getElementById('start-onboarding-btn').addEventListener('click', () => {
            localStorage.setItem('neoai_onboarding_completed', 'true');
            switchScreen('loading');
            startModelLoading();
        });

        document.getElementById('cancel-load-btn').addEventListener('click', () => {
            location.reload();
        });

        let pipe = null;

        async function startModelLoading() {
            try {
                UI.loading.stepDownload.style.opacity = '1';
                UI.loading.stepDownload.querySelector('div').classList.add('bg-blue-500', 'border-blue-500', 'text-black');
                
                const progressCallback = (info) => {
                    // Update UI based on info
                    if (info.status === 'progress') {
                        const percent = info.progress ? Math.round(info.progress) : 0;
                        UI.loading.bar.style.width = `${percent}%`;
                        UI.loading.percent.textContent = `${percent}%`;
                        if(info.file) UI.loading.detail.textContent = `Lade ${info.file}...`;
                        
                        // Wenn Download fast fertig, aktiviere GPU Schritt visuell
                        if(percent > 95) {
                            UI.loading.stepGpu.style.opacity = '1';
                            UI.loading.stepDownload.querySelector('div').innerHTML = '<i data-lucide="check" class="w-3 h-3"></i>';
                            lucide.createIcons();
                        }
                    } else if (info.status === 'initiate') {
                         UI.loading.stepGpu.style.opacity = '1';
                         UI.loading.stepGpu.querySelector('div').classList.add('bg-blue-500', 'border-blue-500', 'text-black');
                         UI.loading.detail.textContent = "Kompiliere Shader & lade in VRAM...";
                    } else if (info.status === 'done') {
                        // File done
                    }
                };

                // Initialize Pipeline
                pipe = await pipeline('text-generation', MODEL_ID, {
                    device: 'webgpu',
                    dtype: 'q4', // Low VRAM usage
                    progress_callback: progressCallback,
                });
                
                // Finished
                UI.loading.bar.style.width = '100%';
                UI.loading.percent.textContent = '100%';
                UI.loading.stepGpu.querySelector('div').innerHTML = '<i data-lucide="check" class="w-3 h-3"></i>';
                lucide.createIcons();
                
                state.modelReady = true;
                setTimeout(() => {
                    switchScreen('chat');
                    // Ggf. neuen Chat erstellen wenn keiner da
                    if(state.chats.length === 0) createNewChat();
                    else loadChat(state.chats[0].id);
                }, 800);

            } catch (err) {
                console.error(err);
                if (err.message.includes("WebGPU")) {
                   alert("Fehler: WebGPU wird nicht unterstützt oder ist deaktiviert.");
                } else {
                   alert("Fehler beim Laden des Modells: " + err.message);
                }
                // Reset onboarding so user can try again clearly
                // localStorage.removeItem('neoai_onboarding_completed');
            }
        }


        // --- Chat Logic ---

        function loadChats() {
            const stored = localStorage.getItem('neoai_chats');
            if (stored) state.chats = JSON.parse(stored);
            renderHistory();
        }

        function saveChats() {
            localStorage.setItem('neoai_chats', JSON.stringify(state.chats));
            renderHistory();
        }

        function createNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: 'Neuer Chat',
                messages: [],
                timestamp: Date.now()
            };
            state.chats.unshift(newChat);
            loadChat(newChat.id);
            closeMobileMenu();
        }

        function loadChat(id) {
            state.currentChatId = id;
            const chat = state.chats.find(c => c.id === id);
            
            // Clean UI
            UI.chatContainer.innerHTML = '';
            UI.chatContainer.appendChild(UI.placeholder); // Add placeholder back
            
            if (chat.messages.length > 0) {
                UI.placeholder.classList.add('hidden');
                chat.messages.forEach(msg => renderMessage(msg.role, msg.content));
            } else {
                UI.placeholder.classList.remove('hidden');
            }
            
            renderHistory();
            scrollToBottom();
        }

        function renderHistory() {
            UI.historyList.innerHTML = '';
            state.chats.forEach(chat => {
                const btn = document.createElement('button');
                const isActive = state.currentChatId === chat.id;
                btn.className = `w-full text-left px-3 py-2.5 rounded-lg text-sm mb-1 flex items-center justify-between group transition ${isActive ? 'bg-white/10 text-white font-medium' : 'text-secondary hover:bg-white/5 hover:text-primary'}`;
                
                btn.innerHTML = `
                    <span class="truncate pr-2">${chat.title || 'Neuer Chat'}</span>
                    <div class="opacity-0 group-hover:opacity-100 hover:text-red-400 p-1 rounded transition stop-prop">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </div>
                `;
                
                // Delete Click
                btn.querySelector('.stop-prop').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteChat(chat.id);
                });
                
                btn.addEventListener('click', () => loadChat(chat.id));
                UI.historyList.appendChild(btn);
            });
            lucide.createIcons();
        }

        function deleteChat(id) {
            state.chats = state.chats.filter(c => c.id !== id);
            saveChats();
            if (state.currentChatId === id) {
                if(state.chats.length > 0) loadChat(state.chats[0].id);
                else createNewChat();
            } else {
                renderHistory(); // Refresh list distinct
            }
        }

        function renderMessage(role, content, animated = false) {
            UI.placeholder.classList.add('hidden');
            
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            // Design: User = White bubble, Black text. AI = Transparent/Glass, White text.
            if (role === 'user') {
                bubble.className = "max-w-[85%] md:max-w-[70%] bg-white text-black px-5 py-3.5 rounded-2xl rounded-br-none shadow-lg text-sm md:text-base";
                bubble.textContent = content; // Secure text
            } else {
                bubble.className = "max-w-[90%] md:max-w-[80%] px-2 py-2 text-primary prose prose-invert text-sm md:text-base";
                bubble.innerHTML = DOMPurify.sanitize(marked.parse(content));
            }

            if(animated) bubble.classList.add('typing-cursor');

            wrapper.appendChild(bubble);
            UI.chatContainer.appendChild(wrapper);
            scrollToBottom();
            return bubble;
        }

        function scrollToBottom() {
            UI.chatContainer.scrollTop = UI.chatContainer.scrollHeight;
        }

        // --- Interaction ---

        async function handleSend() {
            const text = UI.input.value.trim();
            if (!text || state.isGenerating) return;

            UI.input.value = '';
            UI.input.style.height = '52px';
            
            // Add User Msg
            const chat = state.chats.find(c => c.id === state.currentChatId);
            chat.messages.push({ role: 'user', content: text, timestamp: Date.now() });
            
            // Update Title if new
            if (chat.messages.length === 1) {
                chat.title = text.slice(0, 24) + (text.length > 24 ? '...' : '');
                saveChats(); // Save title
            }

            renderMessage('user', text);

            // Generate
            state.isGenerating = true;
            UI.sendBtn.disabled = true;

            const aiBubble = renderMessage('assistant', '', true);
            let fullResponse = "";

            try {
                 // Construct Prompt
                const history = chat.messages.map(m => 
                    `<|im_start|>${m.role}\n${m.content}<|im_end|>\n`
                ).join('');
                const prompt = `<|im_start|>system\nDu bist NeoAI, ein hilfreicher Assistent.<|im_end|>\n${history}<|im_start|>assistant\n`;

                // Run Generation
                const output = await pipe(prompt, {
                    max_new_tokens: 512,
                    temperature: 0.7,
                    do_sample: true,
                    // Streaming simulation via callback patch or monolithic wait
                    callback_function: (beams) => {
                         // V3 Alpha changes often, beam output inspection is tricky locally without streamer
                    }
                });
                
                // Get result
                const generatedText = output[0].generated_text;
                let responseContent = generatedText.substring(prompt.length).replace('<|im_end|>', '').trim();
                
                fullResponse = responseContent;
                aiBubble.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
                
                // Save
                chat.messages.push({ role: 'assistant', content: fullResponse, timestamp: Date.now() });
                saveChats();

            } catch (err) {
                 aiBubble.innerHTML = `<span class="text-red-400">Fehler: ${err.message}</span>`;
            } finally {
                aiBubble.classList.remove('typing-cursor');
                state.isGenerating = false;
                UI.sendBtn.disabled = false;
                UI.input.focus();
            }
        }

        // --- Custom Confirmation Dialog ---
        function showConfirm(title, msg, onConfirm) {
            UI.confirm.title.textContent = title;
            UI.confirm.msg.textContent = msg;
            
            const handleOk = () => {
                onConfirm();
                UI.modals.confirm.close();
                cleanup();
            };
            const handleCancel = () => {
                UI.modals.confirm.close();
                cleanup();
            };
            const cleanup = () => {
                UI.confirm.ok.removeEventListener('click', handleOk);
                UI.confirm.cancel.removeEventListener('click', handleCancel);
            };

            UI.confirm.ok.addEventListener('click', handleOk);
            UI.confirm.cancel.addEventListener('click', handleCancel);
            
            UI.modals.confirm.showModal();
        }

        // --- Settings Functionality ---

        document.getElementById('settings-btn').addEventListener('click', () => UI.modals.settings.showModal());
        document.getElementById('close-settings').addEventListener('click', () => UI.modals.settings.close());
        
        document.getElementById('delete-history-btn').addEventListener('click', () => {
             showConfirm('Verlauf löschen?', 'Alle deine Chats werden unwiderruflich gelöscht.', () => {
                 state.chats = [];
                 state.currentChatId = null;
                 saveChats();
                 createNewChat();
                 UI.modals.settings.close();
             });
        });

        document.getElementById('delete-model-btn').addEventListener('click', () => {
            showConfirm('Cache leeren?', 'Das Modell (~1GB) muss beim nächsten Mal erneut geladen werden.', async () => {
                try {
                    const cacheNames = await caches.keys();
                    for (const name of cacheNames) {
                        if (name.includes('transformers')) await caches.delete(name);
                    }
                    localStorage.removeItem('neoai_onboarding_completed'); // Reset onboarding
                    location.reload(); 
                } catch(e) { console.error(e); }
            });
        });

        // --- Global Events ---
        
        UI.input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
            e.target.style.height = 'auto';
            e.target.style.height = e.target.scrollHeight + 'px';
        });
        
        UI.sendBtn.addEventListener('click', handleSend);
        
        // Mobile UI
        const openMobileMenu = () => {
            UI.sidebar.style.transform = 'translateX(0)';
            UI.overlay.style.opacity = '1';
            UI.overlay.style.pointerEvents = 'auto';
        };
        const closeMobileMenu = () => {
            // Check CSS media query before hiding if desktop
            if(window.innerWidth < 768) {
                UI.sidebar.style.transform = 'translateX(-100%)';
                UI.overlay.style.opacity = '0';
                UI.overlay.style.pointerEvents = 'none';
            }
        };

        document.getElementById('menu-btn').addEventListener('click', openMobileMenu);
        UI.overlay.addEventListener('click', closeMobileMenu);
        document.getElementById('new-chat-btn').addEventListener('click', createNewChat);
        document.getElementById('new-chat-mobile').addEventListener('click', createNewChat);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
